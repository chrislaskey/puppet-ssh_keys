<%
# Creates a private and public key on the puppetmaster server if needed. Then
# returns the private key for placement on the puppet client. The public key
# is collected the next time Puppet runs on the target machine.
#
# Technical note: ERB files in puppet run on the puppetmaster as the puppet
# user, not as root.

def sh (command)
	%x[ #{command} ]
	return $? == 0
end

def error (message)
	raise Puppet::Error, "\nError creating ssh key for user '#{local_user}'. #{message}"
end

def set_variables ()
	$puppetmaster_target_fqdn_key_dir = "#{puppetmaster_key_dir}/#{target_fqdn}"
	$private_key = "#{$puppetmaster_target_fqdn_key_dir}/#{target_user}.#{local_user}.#{fqdn}"
	$public_key = "#{$private_key}.pub"
	$user_hostname_generated = "`id -un`@`hostname`"
	$user_hostname_replacement = "#{local_user}\@#{hostname}"
end

def verify_puppetmaster_environment ()
	command = "mkdir -p #{puppetmaster_key_dir}"
	if not sh (command)
		error "The key path on puppetmaster does not exist and could not be created, '#{puppetmaster_key_dir}'."
	end

	command = "mkdir -p #{$puppetmaster_target_fqdn_key_dir}"
	if not sh (command)
		error "The target machine's fqdn key directory on puppetmaster does not exist and could not be created, '#{$puppetmaster_target_fqdn_key_dir}'."
	end

	command = "chmod 0700 #{$puppetmaster_target_fqdn_key_dir}"
	return sh (command)
end

def generate_keys ()
	command = "ssh-keygen -f '#{$private_key}' -N ''"
	return sh (command)
end

def change_public_key_user_and_hostname ()
	command = "sed -i'' -e \"s/#{$user_hostname_generated}/#{$user_hostname_replacement}/\" #{$public_key}"
	return sh (command)
end

def return_private_key_content ()
	return File.read($private_key)
end

def remove_private_key ()
	command = "rm #{$private_key}"
	return sh (command)
end

# Execution

set_variables
verify_puppetmaster_environment
generate_keys
change_public_key_user_and_hostname
private_key_content = return_private_key_content
remove_private_key
%><%= private_key_content %>
